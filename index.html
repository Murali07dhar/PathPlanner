<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEOPATH | Matrix Learning Protocol</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Matrix Theme Overrides */
        body {
            background-color: #000000;
            color: #22c55e;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #000; 
        }
        ::-webkit-scrollbar-thumb {
            background: #15803d; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #22c55e; 
        }

        /* Utility for hiding elements */
        .hidden { display: none; }
        
        /* Animation Classes */
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen selection:bg-green-900 selection:text-green-100 pb-20">

    <!-- App Container -->
    <div id="app"></div>

    <!-- Modals Container -->
    <div id="modal-root"></div>

    <script>
        // --- State Management ---
        const state = {
            courses: [],
            activeCourseId: null,
            editingCourseId: null, // Tracks if we are editing a course
            isModalOpen: false,
            loading: true
        };

        // --- Utility Functions ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString();

        // --- Data Persistence ---
        function loadData() {
            const saved = localStorage.getItem('myCoursePaths');
            if (saved) {
                state.courses = JSON.parse(saved);
            }
            state.loading = false;
            render();
        }

        function saveData() {
            localStorage.setItem('myCoursePaths', JSON.stringify(state.courses));
            render();
        }

        // --- Actions ---
        
        // Navigation
        window.openCreateModal = () => {
            state.editingCourseId = null; // Reset edit state
            state.isModalOpen = true;
            render();
            // Focus input after render
            setTimeout(() => document.getElementById('new-course-title')?.focus(), 50);
        };

        window.openEditCourseModal = (e, courseId) => {
            e.stopPropagation(); // Prevent opening the course
            const course = state.courses.find(c => c.id === courseId);
            if (!course) return;

            state.editingCourseId = courseId;
            state.isModalOpen = true;
            render();

            // Pre-fill data
            setTimeout(() => {
                const titleInput = document.getElementById('new-course-title');
                const descInput = document.getElementById('new-course-desc');
                if (titleInput && descInput) {
                    titleInput.value = course.title;
                    descInput.value = course.description;
                    titleInput.focus();
                }
            }, 50);
        };

        window.closeModal = () => {
            state.isModalOpen = false;
            state.editingCourseId = null;
            render();
        };

        window.openCourse = (id) => {
            state.activeCourseId = id;
            render();
        };

        window.backToDashboard = () => {
            state.activeCourseId = null;
            render();
        };

        // Course CRUD
        window.handleCourseSubmit = (e) => {
            e.preventDefault();
            const titleInput = document.getElementById('new-course-title');
            const descInput = document.getElementById('new-course-desc');
            
            if (!titleInput.value.trim()) return;

            if (state.editingCourseId) {
                // Update Existing
                const course = state.courses.find(c => c.id === state.editingCourseId);
                if (course) {
                    course.title = titleInput.value;
                    course.description = descInput.value;
                }
                state.editingCourseId = null;
            } else {
                // Create New
                const newCourse = {
                    id: generateId(),
                    title: titleInput.value,
                    description: descInput.value,
                    createdAt: new Date().toISOString(),
                    tasks: []
                };
                state.courses.unshift(newCourse);
                // Optionally auto-open only on create, not edit
                if (!state.editingCourseId) {
                    state.activeCourseId = newCourse.id; 
                }
            }

            state.isModalOpen = false;
            saveData();
        };

        window.deleteCourse = (e, courseId) => {
            e.stopPropagation(); // Prevent opening the course
            if (!confirm('WARNING: Purge this construct from memory? This action cannot be undone.')) return;
            
            state.courses = state.courses.filter(c => c.id !== courseId);
            saveData();
        };

        // Task CRUD
        window.addTask = () => {
            const course = state.courses.find(c => c.id === state.activeCourseId);
            if (!course) return;

            const newTask = {
                id: generateId(),
                title: '',
                description: '',
                link: '',
                isCompleted: false,
                _isEditing: true // UI state for edit mode
            };

            course.tasks.push(newTask);
            saveData();
        };

        window.editTask = (taskId) => {
            const course = state.courses.find(c => c.id === state.activeCourseId);
            const task = course.tasks.find(t => t.id === taskId);
            if (task) {
                task._isEditing = true;
                saveData();
            }
        };

        window.saveTask = (taskId) => {
            const course = state.courses.find(c => c.id === state.activeCourseId);
            const task = course.tasks.find(t => t.id === taskId);
            
            const titleVal = document.getElementById(`title-${taskId}`).value;
            const descVal = document.getElementById(`desc-${taskId}`).value;
            const linkVal = document.getElementById(`link-${taskId}`).value;

            if (!titleVal.trim()) return;

            task.title = titleVal;
            task.description = descVal;
            task.link = linkVal;
            task._isEditing = false;
            
            saveData();
        };

        window.deleteTask = (taskId) => {
            if (!confirm('Delete this protocol node?')) return;
            
            const course = state.courses.find(c => c.id === state.activeCourseId);
            course.tasks = course.tasks.filter(t => t.id !== taskId);
            saveData();
        };

        window.moveTask = (index, direction) => {
            const course = state.courses.find(c => c.id === state.activeCourseId);
            const tasks = course.tasks;
            const targetIndex = index + direction;

            if (targetIndex >= 0 && targetIndex < tasks.length) {
                [tasks[index], tasks[targetIndex]] = [tasks[targetIndex], tasks[index]];
                saveData();
            }
        };

        // --- Render Functions ---

        function Header() {
            const showNewBtn = state.courses.length > 0 && !state.activeCourseId;
            return `
                <header class="bg-black border-b border-green-900/50 sticky top-0 z-30 shadow-[0_0_20px_rgba(0,50,0,0.5)]">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                        <div class="flex items-center gap-2 group cursor-default" onclick="window.backToDashboard()">
                            <div class="bg-black border border-green-500 text-green-500 p-1.5 rounded group-hover:bg-green-500 group-hover:text-black transition-colors shadow-[0_0_10px_rgba(34,197,94,0.4)]">
                                <i data-lucide="terminal" class="w-5 h-5"></i>
                            </div>
                            <h1 class="text-xl font-bold text-green-500 tracking-[0.2em] group-hover:text-green-400 transition-colors cursor-pointer">
                                NEO<span class="text-green-700">PATH</span>
                            </h1>
                        </div>
                        
                        ${showNewBtn ? `
                        <button onclick="window.openCreateModal()" class="inline-flex items-center justify-center px-4 py-2 text-sm font-bold rounded border border-green-600 text-green-500 hover:bg-green-600 hover:text-black transition-all shadow-[0_0_10px_rgba(34,197,94,0.2)] uppercase tracking-wide">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            New Construct
                        </button>
                        ` : ''}
                    </div>
                </header>
            `;
        }

        function EmptyState() {
            return `
                <div class="max-w-2xl mx-auto mt-10 px-4 animate-fade-in">
                    <div class="text-center py-20 px-4 bg-zinc-900 rounded-2xl border-2 border-dashed border-green-900 flex flex-col items-center justify-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-[linear-gradient(rgba(0,50,0,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(0,50,0,0.1)_1px,transparent_1px)] bg-[size:20px_20px] pointer-events-none"></div>
                        <div class="bg-black border border-green-900 p-4 rounded-full shadow-[0_0_15px_rgba(34,197,94,0.2)] mb-4 relative z-10">
                            <i data-lucide="terminal" class="w-8 h-8 text-green-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-green-400 mb-2 relative z-10 tracking-widest">SYSTEM EMPTY</h3>
                        <p class="text-green-700 max-w-sm mb-8 relative z-10 font-medium">
                            No constructs loaded. Initialize a new learning protocol.
                        </p>
                        <button onclick="window.openCreateModal()" class="relative z-10 inline-flex items-center justify-center px-6 py-3 border border-green-500 text-base font-bold rounded text-green-500 hover:bg-green-500 hover:text-black transition-all shadow-[0_0_10px_rgba(34,197,94,0.2)] hover:shadow-[0_0_20px_rgba(34,197,94,0.6)] uppercase tracking-wider">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            Initialize Path
                        </button>
                    </div>
                </div>
            `;
        }

        function Dashboard() {
            if (state.courses.length === 0) return EmptyState();

            const coursesHtml = state.courses.map(course => `
                <div onclick="window.openCourse('${course.id}')" class="flex flex-col h-full bg-zinc-900 rounded-xl border border-green-900/60 hover:border-green-500 hover:shadow-[0_0_15px_rgba(34,197,94,0.15)] transition-all cursor-pointer group relative overflow-hidden animate-fade-in">
                    <div class="absolute inset-0 bg-gradient-to-b from-transparent via-green-500/5 to-transparent -translate-y-full group-hover:translate-y-full transition-transform duration-1000 ease-in-out pointer-events-none"></div>

                    <div class="p-6 flex-1">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-black border border-green-900 text-green-500 rounded group-hover:bg-green-900/30 group-hover:text-green-400 transition-colors">
                                <i data-lucide="book-open" class="w-6 h-6"></i>
                            </div>
                            <span class="text-xs font-bold text-green-800 bg-black border border-green-900/50 px-2 py-1 rounded">
                                ${formatDate(course.createdAt)}
                            </span>
                        </div>
                        <h3 class="text-lg font-bold text-green-400 mb-2 tracking-tight group-hover:text-green-300">${course.title}</h3>
                        <p class="text-green-700 text-sm line-clamp-2 font-medium">${course.description || ''}</p>
                    </div>

                    <div class="px-6 py-4 border-t border-green-900/30 bg-black/20 flex items-center justify-between">
                        <div class="text-xs font-bold text-green-800 uppercase tracking-wider">
                            ${course.tasks.length} NODES
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center gap-2">
                             <button onclick="window.openEditCourseModal(event, '${course.id}')" class="p-1.5 text-green-700 hover:text-green-400 hover:bg-green-900/20 rounded transition-colors" title="Edit Properties">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="window.deleteCourse(event, '${course.id}')" class="p-1.5 text-green-700 hover:text-red-500 hover:bg-red-900/10 rounded transition-colors" title="Purge Construct">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                            <div class="w-px h-4 bg-green-900 mx-1"></div>
                            <div class="flex items-center text-green-500 text-sm font-bold uppercase tracking-wide group-hover:text-green-300">
                                Open <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="mb-6 flex items-center justify-between border-b border-green-900 pb-4">
                        <h2 class="text-2xl font-bold text-green-400 tracking-wider">LOADED CONSTRUCTS</h2>
                        <span class="text-sm text-green-700 font-bold border border-green-900 px-2 py-1 rounded">
                            ${state.courses.length} ${state.courses.length === 1 ? 'FILE' : 'FILES'}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${coursesHtml}
                    </div>
                </div>
            `;
        }

        function TaskItem(task, index, isFirst, isLast) {
            // Rope Logic
            const topConnector = !isFirst ? '<div class="h-4 w-0.5 bg-green-900"></div>' : '';
            const bottomConnector = !isLast ? '<div class="flex-1 w-0.5 bg-green-900 min-h-[4rem]"></div>' : '';
            
            // Edit Mode HTML
            if (task._isEditing) {
                return `
                <div class="relative flex items-start gap-4 group animate-fade-in">
                    <div class="flex flex-col items-center mt-1">
                        ${topConnector}
                        <div class="z-10 w-6 h-6 rounded-full border-2 border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)] flex items-center justify-center bg-black">
                             <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                        </div>
                        ${bottomConnector}
                    </div>
                    <div class="flex-1 pb-8">
                        <div class="bg-zinc-900 rounded-xl border border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.15)] p-4 transition-all duration-200 space-y-3">
                            <input type="text" id="title-${task.id}" value="${task.title}" placeholder="Task Title" class="w-full text-lg font-bold text-green-400 bg-black/50 border border-green-900 rounded px-2 py-1 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none placeholder:text-green-900">
                            
                            <textarea id="desc-${task.id}" rows="2" placeholder="Description (optional)" class="w-full text-sm text-green-600 bg-black/50 border border-green-900 rounded px-2 py-1 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none placeholder:text-green-900 resize-none">${task.description || ''}</textarea>
                            
                            <div class="flex items-center gap-2 bg-black/30 p-2 rounded border border-green-900">
                                <i data-lucide="link" class="w-4 h-4 text-green-700"></i>
                                <input type="text" id="link-${task.id}" value="${task.link || ''}" placeholder="https://example.com/resource" class="flex-1 bg-transparent text-sm text-green-500 placeholder:text-green-900 border-none p-0 focus:ring-0 outline-none">
                            </div>
                            
                            <button onclick="window.saveTask('${task.id}')" class="w-full py-2 bg-green-700 text-black rounded text-sm font-bold hover:bg-green-600 uppercase tracking-wide">
                                Save Protocol
                            </button>
                        </div>
                    </div>
                </div>`;
            }

            // View Mode HTML
            return `
            <div class="relative flex items-start gap-4 group animate-fade-in">
                <div class="flex flex-col items-center mt-1">
                    ${topConnector}
                    <div class="z-10 w-6 h-6 rounded-full border-2 border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)] flex items-center justify-center ${task.isCompleted ? 'bg-green-500' : 'bg-black'}">
                        <div class="w-1.5 h-1.5 rounded-full ${task.isCompleted ? 'bg-black' : 'bg-green-500'}"></div>
                    </div>
                    ${bottomConnector}
                </div>
                <div class="flex-1 pb-8">
                    <div class="bg-zinc-900 rounded-xl border border-green-900 shadow-sm hover:border-green-600 p-4 transition-all duration-200">
                        <div class="flex justify-between items-start">
                            <h4 class="text-lg font-bold text-green-400 tracking-tight">${task.title}</h4>
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="window.moveTask(${index}, -1)" ${isFirst ? 'disabled style="opacity:0.3"' : ''} class="p-1 hover:bg-green-900/30 rounded text-green-800 hover:text-green-400">
                                    <i data-lucide="arrow-up" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.moveTask(${index}, 1)" ${isLast ? 'disabled style="opacity:0.3"' : ''} class="p-1 hover:bg-green-900/30 rounded text-green-800 hover:text-green-400">
                                    <i data-lucide="arrow-down" class="w-4 h-4"></i>
                                </button>
                                <div class="w-px h-4 bg-green-900 mx-1"></div>
                                <button onclick="window.editTask('${task.id}')" class="p-1 hover:bg-green-900/30 rounded text-green-800 hover:text-green-400">
                                    Edit
                                </button>
                                <button onclick="window.deleteTask('${task.id}')" class="p-1 hover:bg-red-900/20 rounded text-green-800 hover:text-red-500">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        ${task.description ? `<p class="text-green-700 text-sm mt-1 mb-3 font-medium">${task.description}</p>` : ''}
                        ${task.link ? `
                            <a href="${task.link}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-3 py-1.5 bg-green-900/20 border border-green-900/50 text-green-500 text-sm font-medium rounded hover:bg-green-900/40 hover:border-green-500 transition-all">
                                <i data-lucide="external-link" class="w-3.5 h-3.5"></i> Access Data
                            </a>
                        ` : ''}
                    </div>
                </div>
            </div>`;
        }

        function PathEditor() {
            const course = state.courses.find(c => c.id === state.activeCourseId);
            if (!course) return '';

            const tasksHtml = course.tasks.map((task, idx) => 
                TaskItem(task, idx, idx === 0, idx === course.tasks.length - 1)
            ).join('');

            return `
                <div class="sticky top-0 z-30 bg-black/90 backdrop-blur-sm border-b border-green-900 shadow-[0_4px_20px_-10px_rgba(34,197,94,0.3)]">
                    <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                        <button onclick="window.backToDashboard()" class="flex items-center text-green-700 hover:text-green-400 transition-colors font-bold uppercase tracking-wider text-sm">
                            <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Return to Matrix
                        </button>
                        <div class="flex items-center gap-3">
                             <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#22c55e]"></div>
                             <span class="text-xs text-green-800 font-bold uppercase tracking-widest">System Synced</span>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto px-4 py-8 animate-fade-in">
                    <div class="mb-8 border-b border-green-900/50 pb-6">
                        <h1 class="text-3xl font-bold text-green-400 mb-2 tracking-tight drop-shadow-[0_0_8px_rgba(34,197,94,0.5)]">${course.title}</h1>
                        <p class="text-green-700 font-medium">${course.description || ''}</p>
                    </div>

                    <div class="relative pl-4">
                       ${course.tasks.length > 0 ? '<div class="absolute left-[27px] top-4 bottom-12 w-0.5 bg-green-900/50 -z-10"></div>' : ''}

                       <div class="space-y-0">
                           ${tasksHtml}
                       </div>

                       <div class="flex items-start gap-4 mt-2">
                         <div class="flex flex-col items-center">
                           ${course.tasks.length > 0 ? '<div class="h-4 w-0.5 bg-green-900"></div>' : ''}
                           <button onclick="window.addTask()" class="w-8 h-8 rounded-full bg-black border border-green-500 text-green-500 hover:bg-green-500 hover:text-black hover:shadow-[0_0_15px_rgba(34,197,94,0.6)] flex items-center justify-center transition-all duration-300 group">
                             <i data-lucide="plus" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300"></i>
                           </button>
                         </div>
                         <div class="pt-1">
                           <button onclick="window.addTask()" class="text-green-500 font-bold hover:text-green-400 hover:shadow-[0_0_20px_rgba(34,197,94,0.4)] transition-all uppercase tracking-wide text-sm">
                             Initialize New Construct
                           </button>
                           <p class="text-xs text-green-800 mt-1">Append new data node to sequence</p>
                         </div>
                       </div>
                    </div>
                </div>
            `;
        }

        function CreateModal() {
            if (!state.isModalOpen) return '';

            const isEdit = !!state.editingCourseId;
            const title = isEdit ? 'Modify Construct' : 'New Construct';
            const btnText = isEdit ? 'Update' : 'Compile';

            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                    <div class="bg-zinc-900 border border-green-500 rounded-xl shadow-[0_0_50px_rgba(34,197,94,0.2)] w-full max-w-md overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b border-green-900">
                            <h2 class="text-xl font-bold text-green-400 uppercase tracking-widest flex items-center gap-2">
                                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                ${title}
                            </h2>
                            <button onclick="window.closeModal()" class="text-green-800 hover:text-green-500 transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="window.handleCourseSubmit(event)" class="p-6 space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-green-700 uppercase tracking-wider mb-1">Construct Identifier</label>
                                <input type="text" id="new-course-title" placeholder="e.g. AGENT TRAINING v1.0" class="w-full px-4 py-2 bg-black border border-green-800 text-green-400 rounded focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none transition-all placeholder:text-green-900">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-green-700 uppercase tracking-wider mb-1">Parameters</label>
                                <textarea id="new-course-desc" rows="3" placeholder="Define construct parameters..." class="w-full px-4 py-2 bg-black border border-green-800 text-green-400 rounded focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none transition-all resize-none placeholder:text-green-900"></textarea>
                            </div>
                            
                            <div class="pt-4 flex gap-3">
                                <button type="button" onclick="window.closeModal()" class="flex-1 px-4 py-2 border border-green-800 text-green-600 font-bold rounded hover:bg-green-900/20 hover:text-green-400 transition-colors uppercase tracking-wide">
                                    Abort
                                </button>
                                <button type="submit" class="flex-1 px-4 py-2 bg-green-700 text-black font-bold rounded hover:bg-green-600 transition-colors shadow-[0_0_15px_rgba(34,197,94,0.3)] uppercase tracking-wide">
                                    ${btnText}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        // --- Main Render Loop ---
        function render() {
            const app = document.getElementById('app');
            const modalRoot = document.getElementById('modal-root');
            
            // Loading State
            if (state.loading) {
                app.innerHTML = `
                    <div class="min-h-screen flex flex-col items-center justify-center">
                        <div class="relative">
                           <div class="w-16 h-16 border-4 border-green-900 border-t-green-500 rounded-full animate-spin"></div>
                           <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-green-700 animate-pulse">LOAD</div>
                        </div>
                        <p class="mt-4 text-green-800 text-sm font-bold tracking-widest animate-pulse">DECRYPTING...</p>
                    </div>`;
                return;
            }

            // Main View Routing
            if (state.activeCourseId) {
                app.innerHTML = PathEditor();
            } else {
                app.innerHTML = Header() + Dashboard();
            }

            // Modal
            modalRoot.innerHTML = CreateModal();

            // Refresh Icons
            lucide.createIcons();
        }

        // Initialize
        loadData();

    </script>
</body>
</html>
